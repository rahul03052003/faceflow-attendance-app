rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // This function can only be used in 'read' rules.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // This is for READ rules ONLY. The 'admin@gmail.com' check is a fallback.
    function isAdmin() {
        return getUserRole(request.auth.uid) == 'Admin' || request.auth.email == 'admin@gmail.com';
    }
    
    function isTeacher() {
      return getUserRole(request.auth.uid) == 'Teacher';
    }


    // =================================
    // User Collection Rules
    // =================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create a user. The app UI restricts this to Admins/Teachers.
      allow create: if isAuthenticated();

      // An admin can update anyone.
      // A user can update their own profile.
      // A teacher can update a user ONLY IF that user's existing role is 'Student'.
      // This uses `resource.data` which is valid in update rules.
      allow update: if isAuthenticated() &&
                    (isOwner(userId) || resource.data.role == 'Student');

      // A user can delete themselves.
      // A teacher can delete a student.
      allow delete: if isAuthenticated() &&
                    (isOwner(userId) || resource.data.role == 'Student');
    }

    // =================================
    // Subject Collection Rules
    // =================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();

      // Any authenticated user can create a subject. The app UI controls who sees the button.
      allow create: if isAuthenticated();

      // A user can update/delete a subject if they are the assigned teacher for that subject.
      allow update, delete: if isAuthenticated() && (resource.data.teacherId == request.auth.uid);
    }

    // =================================
    // Attendance Collection Rules
    // =================================
    match /attendance/{attendanceId} {
      allow list, read: if isAuthenticated();

      // A teacher can create a record for a subject they teach.
      // This uses `get` on a different path, which is allowed for `create` rules.
      allow create: if get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid;
      
      // Attendance records are immutable.
      allow update, delete: if false;
    }
  }
}
