rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserRole(userId) {
      // WARNING: This function can only be used in 'read' rules
      // or in 'write' rules on the /users/{userId} path itself.
      // It cannot be used to authorize writes on other collections.
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin(userId) {
      // This helper is for READ rules only. We also handle the special admin email.
      return getUserRole(userId) == 'Admin' || request.auth.email == 'admin@example.com';
    }


    // =================================
    // User Collection Rules
    // =================================
    match /users/{userId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated(); // Admins/Teachers create users in-app

      // A user can update their own profile.
      // A teacher can update a user ONLY if that user IS a student.
      // `resource.data` refers to the document state BEFORE the change. This is valid.
      allow update: if isAuthenticated() &&
                    (isOwner(userId) ||
                     (getUserRole(request.auth.uid) == 'Teacher' && resource.data.role == 'Student') ||
                     isAdmin(request.auth.uid)
                    );

      // A user can delete their own profile.
      // A teacher can delete a user ONLY if that user IS a student.
      // An admin can delete anyone.
      allow delete: if isAuthenticated() &&
                    (isOwner(userId) ||
                     (getUserRole(request.auth.uid) == 'Teacher' && resource.data.role == 'Student') ||
                     isAdmin(request.auth.uid)
                    );
    }

    // =================================
    // Subject Collection Rules
    // =================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();

      // Any authenticated user can create a subject. App logic controls who sees the button.
      allow create: if isAuthenticated();

      // A user can update/delete a subject if they are the assigned teacher for that subject.
      // `resource.data` is valid here because it's the document being modified.
      // We cannot use isAdmin() here as it performs a `get`.
      // For this app, we'll assume admins are assigned as teachers to subjects they need to manage,
      // or manage them via a Cloud Function in a real app.
      allow update, delete: if isAuthenticated() && (resource.data.teacherId == request.auth.uid);
    }

    // =================================
    // Attendance Collection Rules
    // =================================
    match /attendance/{attendanceId} {
      allow list, read: if isAuthenticated();
      // A teacher can create an attendance record for a subject they teach.
      // This `get` is valid because it's in a `create` rule and Firestore can
      // resolve the path from the incoming data (`request.resource.data`).
      allow create: if getUserRole(request.auth.uid) == 'Teacher' && get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid;
      // Attendance records are immutable.
      allow update, delete: if false;
    }
  }
}
