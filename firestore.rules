rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // This function can only be used in 'read' or 'create' rules for other collections,
    // or within the /users/{userId} match itself.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    function isAdmin(userId) {
       // Also handles the special default admin email.
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'Admin' || request.auth.email == 'admin@gmail.com';
    }

    // =================================
    // User Collection Rules
    // =================================
    match /users/{userId} {
      // Anyone authenticated can read user profiles and list them.
      allow read, list: if isAuthenticated();

      // Anyone authenticated can create a user (students for teachers, any for admin).
      allow create: if isAuthenticated();

      // Admins can update anyone. A user can update their own profile.
      // A teacher can update a user ONLY if that user IS a student.
      // `resource.data` refers to the document state before the change. This is valid.
      allow update: if isAuthenticated() && (isOwner(userId) || (getUserRole(request.auth.uid) == 'Admin') || (getUserRole(request.auth.uid) == 'Teacher' && resource.data.role == 'Student'));

      // Admins can delete anyone.
      // A teacher can delete a user ONLY if that user IS a student.
      allow delete: if isAuthenticated() && ((getUserRole(request.auth.uid) == 'Admin') || (getUserRole(request.auth.uid) == 'Teacher' && resource.data.role == 'Student'));
    }

    // =================================
    // Subject Collection Rules
    // =================================
    match /subjects/{subjectId} {
      allow read, create: if isAuthenticated();

      // Admins can update any subject.
      // A teacher can update a subject only if they are the assigned teacher.
      // This rule is valid because it does NOT use a `get()` call.
      allow update: if isAuthenticated() && (isAdmin(request.auth.uid) || (resource.data.teacherId == request.auth.uid));

      // Admins can delete any subject.
      // A teacher can delete a subject only if they are the assigned teacher.
      // This rule is valid because it does NOT use a `get()` call.
      allow delete: if isAuthenticated() && (isAdmin(request.auth.uid) || (resource.data.teacherId == request.auth.uid));
    }

    // =================================
    // Attendance Collection Rules
    // =================================
    match /attendance/{attendanceId} {
      allow list, read: if isAuthenticated();
      // This `get` is valid because it's in a `create` rule.
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Teacher' && get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid;
      // Attendance records are immutable.
      allow update, delete: if false;
    }
  }
}
