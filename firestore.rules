rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // This is the ONLY valid way to check for admin in write rules without a custom claim.
    function isAdmin() {
      return request.auth.email == 'admin@gmail.com';
    }

    // =================================
    // User Collection Rules
    // =================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Admins can create any user.
      // Other authenticated users can only create 'Student' users.
      allow create: if isAdmin() || 
                    (isAuthenticated() && request.resource.data.role == 'Student');

      // Admins can update any user.
      // A user can update their own profile.
      // A teacher can update a user ONLY IF that user's existing role is 'Student'.
      allow update: if isAdmin() || isOwner(userId) || 
                    (isAuthenticated() && resource.data.role == 'Student');

      // Admins can delete any user.
      // A user can delete their own profile.
      // A teacher can delete a user ONLY IF that user's existing role is 'Student'.
      allow delete: if isAdmin() || isOwner(userId) || 
                    (isAuthenticated() && resource.data.role == 'Student');
    }

    // =================================
    // Subject Collection Rules
    // =================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();

      // Any authenticated user (Admin or Teacher) can create a subject.
      allow create: if isAuthenticated();

      // An admin can update/delete any subject.
      // A teacher can update/delete a subject ONLY IF they are the assigned teacher for it.
      // This uses `resource.data` (the document before the change) which is valid.
      allow update, delete: if isAdmin() || 
                            (isAuthenticated() && resource.data.teacherId == request.auth.uid);
    }

    // =================================
    // Attendance Collection Rules
    // =================================
    match /attendance/{attendanceId} {
      // Any authenticated user can list/read attendance.
      // App logic filters this down by role.
      allow read: if isAuthenticated();

      // Only an authenticated user can create an attendance record.
      // Further checks would be complex and better handled by app logic in this simplified model.
      allow create: if isAuthenticated();
      
      // Attendance records are immutable once created.
      allow update, delete: if false;
    }
  }
}
