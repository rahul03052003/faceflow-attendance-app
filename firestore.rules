rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // This function can only be used in 'read' rules.
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // This is for READ rules ONLY. The 'admin@example.com' check is a fallback.
    function isAdmin(userId) {
        return getUserRole(userId) == 'Admin' || request.auth.email == 'admin@example.com';
    }

    // =================================
    // User Collection Rules
    // =================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create a user. The app UI restricts this to Admins/Teachers.
      allow create: if isAuthenticated();

      // Admins can update anyone (checked on client side, this rule is open for them)
      // A user can update their own profile.
      // A teacher can update a user ONLY IF that user's existing role is 'Student'.
      // This uses `resource.data` which is valid in update rules.
      allow update: if isAuthenticated() &&
                    (isOwner(userId) || resource.data.role == 'Student');

      // A user can delete themselves.
      // A teacher can delete a student.
      allow delete: if isAuthenticated() &&
                    (isOwner(userId) || resource.data.role == 'Student');
    }

    // =================================
    // Subject Collection Rules
    // =================================
    match /subjects/{subjectId} {
      allow read: if isAuthenticated();

      // Any authenticated user can create a subject. The app UI controls who sees the button.
      // This removes the invalid `get()` call.
      allow create: if isAuthenticated();

      // A user can update/delete a subject if they are the assigned teacher for that subject.
      // This is a valid ownership check using `resource.data`.
      allow update, delete: if isAuthenticated() && (resource.data.teacherId == request.auth.uid);
    }

    // =================================
    // Attendance Collection Rules
    // =================================
    match /attendance/{attendanceId} {
      // Teachers and Admins can read the full list.
      allow list: if isAuthenticated();
      
      // Teachers can read individual records.
      allow read: if isAuthenticated();

      // A teacher can create a record for a subject they teach. This is a valid use of `get`
      // because Firestore allows checking against incoming data in a `create` rule.
      allow create: if get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid;
      
      // Attendance records are immutable.
      allow update, delete: if false;
    }
  }
}
