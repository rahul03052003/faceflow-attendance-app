
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the requesting user's role is Admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }
    
    // Helper function to check if the requesting user's role is Teacher
    function isTeacher() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Teacher';
    }

    // =================================
    // User Collection Rules
    // =================================
    match /users/{userId} {
      // Any authenticated user can read user profiles.
      allow read: if request.auth != null;

      // Create: Admins can create any user. Teachers can only create Students.
      allow create: if request.auth != null &&
                    (isAdmin() ||
                     (isTeacher() && request.resource.data.role == 'Student'));

      // Update: Admins can update any user. A user can update their own profile.
      // A teacher can update a user IF that user is a Student.
      allow update: if request.auth != null &&
                     (isAdmin() ||
                      request.auth.uid == userId ||
                      (isTeacher() && resource.data.role == 'Student'));

      // Delete: Admins can delete any user. A teacher can delete a user IF that user is a Student.
      allow delete: if request.auth != null &&
                     (isAdmin() ||
                      (isTeacher() && resource.data.role == 'Student'));
    }

    // =================================
    // Subject Collection Rules
    // =================================
    match /subjects/{subjectId} {
      // Any authenticated user can read subject information.
      allow read: if request.auth != null;

      // Teachers can create subjects for themselves. Admins can create any.
      allow create: if request.auth != null &&
                       (isAdmin() || 
                        (isTeacher() && request.auth.uid == request.resource.data.teacherId));
      
      // Teachers can update/delete their own subjects. Admins can update/delete any.
      allow update, delete: if request.auth != null &&
                             (isAdmin() || 
                              (isTeacher() && request.auth.uid == resource.data.teacherId));
    }

    // =================================
    // Attendance Collection Rules
    // =================================
    match /attendance/{attendanceId} {
      // Any authenticated user can list/get attendance records.
      allow list, get: if request.auth != null;

      // Teachers can create records for subjects they teach. Admins can create any.
      allow create: if request.auth != null &&
                    (isAdmin() ||
                     (isTeacher() &&
                      exists(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)) &&
                      get(/databases/$(database)/documents/subjects/$(request.resource.data.subjectId)).data.teacherId == request.auth.uid));
      
      // Nobody can update or delete attendance records to maintain data integrity.
      allow update, delete: if false; 
    }
  }
}
